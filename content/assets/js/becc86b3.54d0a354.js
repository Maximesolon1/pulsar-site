"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[49537],{15680:(e,a,t)=>{t.d(a,{xA:()=>d,yg:()=>g});var n=t(96540);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=n.createContext({}),u=function(e){var a=n.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},d=function(e){var a=u(e.components);return n.createElement(s.Provider,{value:a},e.children)},c="mdxType",p={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=u(t),m=r,g=c["".concat(s,".").concat(m)]||c[m]||p[m]||i;return t?n.createElement(g,l(l({ref:a},d),{},{components:t})):n.createElement(g,l({ref:a},d))}));function g(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=m;var o={};for(var s in a)hasOwnProperty.call(a,s)&&(o[s]=a[s]);o.originalType=e,o[c]="string"==typeof e?e:r,l[1]=o;for(var u=2;u<i;u++)l[u]=t[u];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},19365:(e,a,t)=>{t.d(a,{A:()=>l});var n=t(96540),r=t(20053);const i={tabItem:"tabItem_Ymn6"};function l(e){let{children:a,hidden:t,className:l}=e;return n.createElement("div",{role:"tabpanel",className:(0,r.A)(i.tabItem,l),hidden:t},a)}},89089:(e,a,t)=>{t.d(a,{A:()=>k});var n=t(58168),r=t(96540),i=t(20053),l=t(23104),o=t(56347),s=t(57485),u=t(31682),d=t(89466);function c(e){return function(e){return r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:a}=e;return!!a&&"object"==typeof a&&"value"in a}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:a,label:t,attributes:n,default:r}}=e;return{value:a,label:t,attributes:n,default:r}}))}function p(e){const{values:a,children:t}=e;return(0,r.useMemo)((()=>{const e=a??c(t);return function(e){const a=(0,u.X)(e,((e,a)=>e.value===a.value));if(a.length>0)throw new Error(`Docusaurus error: Duplicate values "${a.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[a,t])}function m(e){let{value:a,tabValues:t}=e;return t.some((e=>e.value===a))}function g(e){let{queryString:a=!1,groupId:t}=e;const n=(0,o.W6)(),i=function(e){let{queryString:a=!1,groupId:t}=e;if("string"==typeof a)return a;if(!1===a)return null;if(!0===a&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:a,groupId:t});return[(0,s.aZ)(i),(0,r.useCallback)((e=>{if(!i)return;const a=new URLSearchParams(n.location.search);a.set(i,e),n.replace({...n.location,search:a.toString()})}),[i,n])]}function y(e){const{defaultValue:a,queryString:t=!1,groupId:n}=e,i=p(e),[l,o]=(0,r.useState)((()=>function(e){let{defaultValue:a,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(a){if(!m({value:a,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${a}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return a}const n=t.find((e=>e.default))??t[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:a,tabValues:i}))),[s,u]=g({queryString:t,groupId:n}),[c,y]=function(e){let{groupId:a}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(a),[n,i]=(0,d.Dv)(t);return[n,(0,r.useCallback)((e=>{t&&i.set(e)}),[t,i])]}({groupId:n}),f=(()=>{const e=s??c;return m({value:e,tabValues:i})?e:null})();(0,r.useLayoutEffect)((()=>{f&&o(f)}),[f]);return{selectedValue:l,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),y(e)}),[u,y,i]),tabValues:i}}var f=t(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function h(e){let{className:a,block:t,selectedValue:o,selectValue:s,tabValues:u}=e;const d=[],{blockElementScrollPositionUntilNextRender:c}=(0,l.a_)(),p=e=>{const a=e.currentTarget,t=d.indexOf(a),n=u[t].value;n!==o&&(c(a),s(n))},m=e=>{let a=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const t=d.indexOf(e.currentTarget)+1;a=d[t]??d[0];break}case"ArrowLeft":{const t=d.indexOf(e.currentTarget)-1;a=d[t]??d[d.length-1];break}}a?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":t},a)},u.map((e=>{let{value:a,label:t,attributes:l}=e;return r.createElement("li",(0,n.A)({role:"tab",tabIndex:o===a?0:-1,"aria-selected":o===a,key:a,ref:e=>d.push(e),onKeyDown:m,onClick:p},l,{className:(0,i.A)("tabs__item",b.tabItem,l?.className,{"tabs__item--active":o===a})}),t??a)})))}function v(e){let{lazy:a,children:t,selectedValue:n}=e;const i=(Array.isArray(t)?t:[t]).filter(Boolean);if(a){const e=i.find((e=>e.props.value===n));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},i.map(((e,a)=>(0,r.cloneElement)(e,{key:a,hidden:e.props.value!==n}))))}function N(e){const a=y(e);return r.createElement("div",{className:(0,i.A)("tabs-container",b.tabList)},r.createElement(h,(0,n.A)({},e,a)),r.createElement(v,(0,n.A)({},e,a)))}function k(e){const a=(0,f.A)();return r.createElement(N,(0,n.A)({key:String(a)},e))}},70900:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>d,contentTitle:()=>s,default:()=>g,frontMatter:()=>o,metadata:()=>u,toc:()=>c});var n=t(58168),r=(t(96540),t(15680)),i=t(89089),l=t(19365);const o={id:"cookbooks-deduplication",title:"Message deduplication",sidebar_label:"Message deduplication",original_id:"cookbooks-deduplication"},s=void 0,u={unversionedId:"cookbooks-deduplication",id:"version-2.6.0/cookbooks-deduplication",title:"Message deduplication",description:"When Message deduplication is enabled, it ensures that each message produced on Pulsar topics is persisted to disk only once, even if the message is produced more than once. Message deduplication is handled automatically on the server side.",source:"@site/versioned_docs/version-2.6.0/cookbooks-deduplication.md",sourceDirName:".",slug:"/cookbooks-deduplication",permalink:"/docs/2.6.0/cookbooks-deduplication",draft:!1,editUrl:"https://github.com/apache/pulsar-site/edit/main/versioned_docs/version-2.6.0/cookbooks-deduplication.md",tags:[],version:"2.6.0",frontMatter:{id:"cookbooks-deduplication",title:"Message deduplication",sidebar_label:"Message deduplication",original_id:"cookbooks-deduplication"},sidebar:"version-2.6.0/docsSidebar",previous:{title:"Topic compaction",permalink:"/docs/2.6.0/cookbooks-compaction"},next:{title:"Non-persistent messaging",permalink:"/docs/2.6.0/cookbooks-non-persistent"}},d={},c=[{value:"How it works",id:"how-it-works",level:2},{value:"Configure message deduplication",id:"configure-message-deduplication",level:2},{value:"Set default value at the broker-level",id:"set-default-value-at-the-broker-level",level:3},{value:"Enable message deduplication",id:"enable-message-deduplication",level:3},{value:"Disable message deduplication",id:"disable-message-deduplication",level:3},{value:"Pulsar clients",id:"pulsar-clients",level:2}],p={toc:c},m="wrapper";function g(e){let{components:a,...t}=e;return(0,r.yg)(m,(0,n.A)({},p,t,{components:a,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"When ",(0,r.yg)("strong",{parentName:"p"},"Message deduplication")," is enabled, it ensures that each message produced on Pulsar topics is persisted to disk ",(0,r.yg)("em",{parentName:"p"},"only once"),", even if the message is produced more than once. Message deduplication is handled automatically on the server side."),(0,r.yg)("p",null,"To use message deduplication in Pulsar, you have to ",(0,r.yg)("a",{parentName:"p",href:"#configure-message-deduplication"},"configure")," your Pulsar brokers and ",(0,r.yg)("a",{parentName:"p",href:"#pulsar-clients"},"clients"),"."),(0,r.yg)("blockquote",null,(0,r.yg)("p",{parentName:"blockquote"},"For more details on message deduplication, refer to ",(0,r.yg)("a",{parentName:"p",href:"/docs/2.6.0/concepts-messaging#message-deduplication"},"Concepts and Architecture"),".")),(0,r.yg)("h2",{id:"how-it-works"},"How it works"),(0,r.yg)("p",null,"You can enable or disable message deduplication on a per-namespace basis. By default, it is ",(0,r.yg)("em",{parentName:"p"},"disabled")," on all namespaces. You can enable it in the following ways:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Enable for all namespaces at the broker-level"),(0,r.yg)("li",{parentName:"ul"},"Enable for specific namespaces with the ",(0,r.yg)("inlineCode",{parentName:"li"},"pulsar-admin namespaces")," interface")),(0,r.yg)("h2",{id:"configure-message-deduplication"},"Configure message deduplication"),(0,r.yg)("p",null,"You can configure message deduplication in Pulsar using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/2.6.0/reference-configuration#broker"},(0,r.yg)("inlineCode",{parentName:"a"},"broker.conf"))," configuration file. The following deduplication-related parameters are available."),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:"left"},"Parameter"),(0,r.yg)("th",{parentName:"tr",align:"left"},"Description"),(0,r.yg)("th",{parentName:"tr",align:"left"},"Default"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"brokerDeduplicationEnabled")),(0,r.yg)("td",{parentName:"tr",align:"left"},"Sets the default behavior for message deduplication in the Pulsar ",(0,r.yg)("a",{parentName:"td",href:"/docs/2.6.0/reference-terminology#broker"},"broker"),". If it is set to ",(0,r.yg)("inlineCode",{parentName:"td"},"true"),", message deduplication is enabled by default on all namespaces; if it is set to ",(0,r.yg)("inlineCode",{parentName:"td"},"false")," (the default), you have to enable or disable deduplication on a per-namespace basis."),(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"false"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"brokerDeduplicationMaxNumberOfProducers")),(0,r.yg)("td",{parentName:"tr",align:"left"},"The maximum number of producers for which information is stored for deduplication purposes."),(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"10000"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"brokerDeduplicationEntriesInterval")),(0,r.yg)("td",{parentName:"tr",align:"left"},"The number of entries after which a deduplication informational snapshot is taken. A larger interval leads to fewer snapshots being taken, though this lengthens the topic recovery time (the time required for entries published after the snapshot to be replayed)."),(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"1000"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"brokerDeduplicationProducerInactivityTimeoutMinutes")),(0,r.yg)("td",{parentName:"tr",align:"left"},"The time of inactivity (in minutes) after which the broker discards deduplication information related to a disconnected producer."),(0,r.yg)("td",{parentName:"tr",align:"left"},(0,r.yg)("inlineCode",{parentName:"td"},"360")," (6 hours)")))),(0,r.yg)("h3",{id:"set-default-value-at-the-broker-level"},"Set default value at the broker-level"),(0,r.yg)("p",null,"By default, message deduplication is ",(0,r.yg)("em",{parentName:"p"},"disabled")," on all Pulsar namespaces. To enable it by default on all namespaces, set the ",(0,r.yg)("inlineCode",{parentName:"p"},"brokerDeduplicationEnabled")," parameter to ",(0,r.yg)("inlineCode",{parentName:"p"},"true")," and re-start the broker."),(0,r.yg)("p",null,"Even if you set the value for ",(0,r.yg)("inlineCode",{parentName:"p"},"brokerDeduplicationEnabled"),", enabling or disabling via Pulsar admin CLI will override the default settings at the broker-level."),(0,r.yg)("h3",{id:"enable-message-deduplication"},"Enable message deduplication"),(0,r.yg)("p",null,"Though message deduplication is disabled by default at broker-level, you can enable message deduplication for specific namespaces using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/2.6.0/reference-pulsar-admin#namespace-set-deduplication"},(0,r.yg)("inlineCode",{parentName:"a"},"pulsar-admin namespace set-deduplication"))," command. You can use the ",(0,r.yg)("inlineCode",{parentName:"p"},"--enable"),"/",(0,r.yg)("inlineCode",{parentName:"p"},"-e")," flag and specify the namespace. The following is an example with ",(0,r.yg)("inlineCode",{parentName:"p"},"<tenant>/<namespace>"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin namespaces set-deduplication \\\n  public/default \\\n  --enable # or just -e\n\n")),(0,r.yg)("h3",{id:"disable-message-deduplication"},"Disable message deduplication"),(0,r.yg)("p",null,"Even if you enable message deduplication at broker-level, you can disable message deduplication for a specific namespace using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/2.6.0/reference-pulsar-admin#namespace-set-deduplication"},(0,r.yg)("inlineCode",{parentName:"a"},"pulsar-admin namespace set-deduplication"))," command. Use the ",(0,r.yg)("inlineCode",{parentName:"p"},"--disable"),"/",(0,r.yg)("inlineCode",{parentName:"p"},"-d")," flag and specify the namespace. The following is an example with ",(0,r.yg)("inlineCode",{parentName:"p"},"<tenant>/<namespace>"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin namespaces set-deduplication \\\n  public/default \\\n  --disable # or just -d\n\n")),(0,r.yg)("h2",{id:"pulsar-clients"},"Pulsar clients"),(0,r.yg)("p",null,"If you enable message deduplication in Pulsar brokers, you need complete the following tasks for your client producers:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"Specify a name for the producer."),(0,r.yg)("li",{parentName:"ol"},"Set the message timeout to ",(0,r.yg)("inlineCode",{parentName:"li"},"0")," (namely, no timeout).")),(0,r.yg)("p",null,"The instructions for Java, Python, and C++ clients are different."),(0,r.yg)(i.A,{defaultValue:"Java clients",values:[{label:"Java clients",value:"Java clients"},{label:"Python clients",value:"Python clients"},{label:"C++ clients",value:"C++ clients"}],mdxType:"Tabs"},(0,r.yg)(l.A,{value:"Java clients",mdxType:"TabItem"},(0,r.yg)("p",null,"To enable message deduplication on a ",(0,r.yg)("a",{parentName:"p",href:"client-libraries-java.md#producers"},"Java producer"),", set the producer name using the ",(0,r.yg)("inlineCode",{parentName:"p"},"producerName")," setter, and set the timeout to ",(0,r.yg)("inlineCode",{parentName:"p"},"0")," using the ",(0,r.yg)("inlineCode",{parentName:"p"},"sendTimeout")," setter."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.client.api.Producer;\nimport org.apache.pulsar.client.api.PulsarClient;\nimport java.util.concurrent.TimeUnit;\n\nPulsarClient pulsarClient = PulsarClient.builder()\n        .serviceUrl("pulsar://localhost:6650")\n        .build();\nProducer producer = pulsarClient.newProducer()\n        .producerName("producer-1")\n        .topic("persistent://public/default/topic-1")\n        .sendTimeout(0, TimeUnit.SECONDS)\n        .create();\n\n'))),(0,r.yg)(l.A,{value:"Python clients",mdxType:"TabItem"},(0,r.yg)("p",null,"To enable message deduplication on a ",(0,r.yg)("a",{parentName:"p",href:"client-libraries-python.md#producers"},"Python producer"),", set the producer name using ",(0,r.yg)("inlineCode",{parentName:"p"},"producer_name"),", and set the timeout to ",(0,r.yg)("inlineCode",{parentName:"p"},"0")," using ",(0,r.yg)("inlineCode",{parentName:"p"},"send_timeout_millis"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-python"},'\nimport pulsar\n\nclient = pulsar.Client("pulsar://localhost:6650")\nproducer = client.create_producer(\n    "persistent://public/default/topic-1",\n    producer_name="producer-1",\n    send_timeout_millis=0)\n\n'))),(0,r.yg)(l.A,{value:"C++ clients",mdxType:"TabItem"},(0,r.yg)("p",null,"To enable message deduplication on a ",(0,r.yg)("a",{parentName:"p",href:"client-libraries-cpp.md#producer"},"C++ producer"),", set the producer name using ",(0,r.yg)("inlineCode",{parentName:"p"},"producer_name"),", and set the timeout to ",(0,r.yg)("inlineCode",{parentName:"p"},"0")," using ",(0,r.yg)("inlineCode",{parentName:"p"},"send_timeout_millis"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-cpp"},'\n#include <pulsar/Client.h>\n\nstd::string serviceUrl = "pulsar://localhost:6650";\nstd::string topic = "persistent://some-tenant/ns1/topic-1";\nstd::string producerName = "producer-1";\n\nClient client(serviceUrl);\n\nProducerConfiguration producerConfig;\nproducerConfig.setSendTimeout(0);\nproducerConfig.setProducerName(producerName);\n\nProducer producer;\n\nResult result = client.createProducer(topic, producerConfig, producer);\n\n')))))}g.isMDXComponent=!0}}]);